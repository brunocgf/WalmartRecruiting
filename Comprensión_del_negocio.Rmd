---
title: "Comprensión del negocio"
author: "Bruno C. Gonzalez"
date: "16/12/2019"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(hrbrthemes)
library(gridExtra)
```


# Antecedentes

El objetivo de la competencia es categorizar las visitas de compras basado en los productos que ha adquirido el cliente, por ejemplo 'visita para una pequeña cena', 'visita para comprar regalos', etc.

Walmart ya ha categorizado los viajes contenidos en estos datos dentro de 38 distintos tipos, usando un metodo propio en un extenso conjunto de datos. El reto es reproducir esta categorización con un conjunto de características más limitado. Esto puede proveer nuevas y más robustas maneras de categorizar los datos.

Primero cargamos los datos

```{r}

l <- c("3","4","5","6","7","8","9","12","14","15","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","999")
train <- read_csv('./data/train.csv',
                  col_types = cols(
                    TripType = col_factor(levels = l),
                    VisitNumber = col_integer(),
                    Weekday = col_character(),
                    ScanCount = col_integer(),
                    DepartmentDescription = col_factor(),
                    FinelineNumber = col_integer()
                  ))
```

```{r}
summary(train)
```

El número de visitas registradas fueron `r length(unique(train$VisitNumber))`, los cuales se distribuyeron por tipo de de viaje de la siguiente manera

```{r}
train %>%
  group_by(TripType) %>% 
  summarise(n = n_distinct(VisitNumber)) %>% 
  ggplot() +
  geom_bar(aes(x = TripType, y = n), stat = 'identity')
```

Esta información se puede comparar con el número de artículos comprados

```{r}
p1 <- train %>%
  group_by(TripType) %>% 
  summarise(n = n_distinct(VisitNumber)) %>% 
  ggplot() +
  geom_bar(aes(x = TripType, y = n), stat = 'identity') +
  labs(title='Número de visitas por tipo de viaje')

p2 <- train %>%
  group_by(TripType) %>% 
  summarise(n = sum(ScanCount)) %>% 
  ggplot() +
  geom_bar(aes(x = TripType, y = n), stat = 'identity') +
  labs(title='Artículos comprados por tipo de viaje')

grid.arrange(p1,p2,nrow=2)

```


A esta información podemos agregar el día de la semana

```{r}
train %>%
  group_by(TripType, Weekday) %>% 
  summarise(n = n_distinct(VisitNumber)) %>% 
  ggplot() +
  geom_bar(aes(x = TripType, y = n, fill = Weekday), stat = 'identity')
```

```{r}
train %>%
  group_by(TripType, Weekday) %>% 
  summarise(n = n_distinct(VisitNumber)) %>% 
  ggplot() +
  geom_bar(aes(x = TripType, y = n), stat = 'identity') +
  facet_wrap(~Weekday)
```

Hay `r length(unique(train$Upc))` distintos tipos de productos en los datos
Hay `r length(unique(train$DepartmentDescription))` distintos tipos de productos en los datos

Ahora veamos la relación entre el tipo de viaje y el Departament, con base el número de artículos comprados.

```{r}
train %>%
  group_by(TripType, DepartmentDescription) %>% 
  summarise(n = sum(ScanCount)) %>% 
  semi_join(train %>% group_by(DepartmentDescription) %>% summarise(n=n()) %>% filter(n>1000),
            by = 'DepartmentDescription') %>% 
  ggplot(aes(x = TripType, y = DepartmentDescription, fill = n)) +
  geom_tile() +
  scale_fill_viridis_c()
  
```

